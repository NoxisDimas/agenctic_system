version: '3.8'

services:
  app:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}
      - POSTGRES_URI=${POSTGRES_URI}
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
    depends_on:
      - qdrant
      - postgres
    volumes:
      - ../:/app
    extra_hosts:
      - "host.docker.internal:host-gateway"

  streamlit:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    command: streamlit run app/ui/streamlit_app.py
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://app:8000
      - LIGHTRAG_API_URL=http://lightrag:9621
    volumes:
      - ../:/app
    depends_on:
      - app

  qdrant:
    image: qdrant/qdrant
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - ../qdrant_data:/qdrant/storage
    restart: always

  neo4j:
    image: neo4j:5.11
    container_name: neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password
    volumes:
      - ../neo4j_data:/data
    healthcheck:
      test: [ "CMD", "cypher-shell", "-u", "neo4j", "-p", "password", "RETURN 1" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always

  lightrag:
    build:
      context: ..
      dockerfile: infra/Dockerfile.lightrag
    container_name: lightrag
    ports:
      - "9621:9621"
    volumes:
      - ../lightrag_data:/data
      - ../.env:/app/data/rag_storage/.env
      - ../config/config.ini:/app/data/rag_storage/config.ini
    environment:
      - EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-mxbai-embed-large:latest}
      - LLM_MODEL=llama-3.3-70b-versatile
      - LLM_BINDING=openai
      - LLM_BINDING_HOST=https://api.groq.com/openai/v1
      - LLM_BINDING_API_KEY=${GROQ_API_KEY}
      - EMBEDDING_BINDING=ollama
      - EMBEDDING_BINDING_HOST=http://ollama:11434
      - OLLAMA_BASE_URL=http://ollama:11434
      - LIGHTRAG_VECTOR_STORAGE=QdrantVectorDBStorage
      - LIGHTRAG_GRAPH_STORAGE=Neo4JStorage
      - QDRANT_URL=http://qdrant:6333
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - LLM_TIMEOUT=900
      - EMBEDDING_TIMEOUT=120
    depends_on:
      qdrant:
        condition: service_started
      neo4j:
        condition: service_healthy
      ollama:
        condition: service_started
    restart: always

  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ../pg_data:/var/lib/postgresql/data

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_storage:/root/.ollama
    restart: always

volumes:
  ollama_storage:
